package proxyserver;import java.util.Enumeration;import java.util.Properties;import java.io.IOException;public class Jhttpp2Admin {		private static Jhttpp2Server server;	private final String JHTTP2ADMIN_VERSION = "0.2.4";	private String myfilename = "";	private Properties p;	private static String status = "";	private static long stat = 0;	static public String error_msg = "";	/** perform admin functions */	public Jhttpp2Admin(String infilename, Jhttpp2Server inserver) {		server = inserver;		myfilename = infilename;	}	public void WebAdmin() throws IOException {		String filename = myfilename;		ParseRequest(filename);		String app = (String) p.get("requesturl");		if (app != null && app.equalsIgnoreCase(server.WEB_CONFIG_FILE)) {			String command = (String) p.get("command");			int sid = 0;			try {				sid = Integer.parseInt((String) p.get("sid"));			} catch (NumberFormatException e_nfe) {				sid = 0;			}			if (command != null) {				if (command.equals("auth")) {					String user = (String) p.get("user");					String passw = (String) p.get("p");					server.AuthenticateUser(user, passw);					if (server.config_auth != 0) {						server.config_session_id = (long) (Math.random() * 100000);						status = "Access granted";						stat = 3;					} else {						status = "Acess forbidden";						stat = 2;					}				} else if (server.config_auth != 0						&& sid == server.config_session_id) {					if (command.equals("logout")) {						server.AuthenticateUser("", "");						server.config_session_id = 0;						status = "Logged out.";						stat = 1;					} else if (command.equals("shutdown")) {						server.shutdownServer();					} else if (command.equals("update_password")) {						String a = (String) p.get("old_pass");						String b = (String) p.get("new_pass");						String c = (String) p.get("new_pass2");						if (!a.equals(server.config_password)) {							status = "Enter the correct old password.";							stat = 5;						} else if (a.equals(b)) {							status = "Old and new password must be different.";							stat = 5;						} else if (a == null || b == null) {							status = "You must enter a password. (should be at least 8 characters long)";							stat = 5;						} else {							if (b.equals(c)) {								server.config_password = b;								server.saveSettings();								stat = 5;								status = "Password sucessfully updated.";							}						}					} else if (command.equals("savefilter")) {						String filterurl = (String) p.get("filter");						String action = (String) p.get("action");						if (filterurl != null && action != null) {							Jhttpp2URLMatch a = new Jhttpp2URLMatch(filterurl,									false/* set to real */,									Integer.parseInt(action), ""/* set to real! */); // add																						// new																						// url																						// match							server.getWildcardDictionary().put(filterurl, a);						}					} else if (command.equals("deletefilter")) {						String filterid = (String) p.get("filterid");						if (filterid != null)							server.getWildcardDictionary().remove(filterid);					}				} // end if (server.config_auth != 0)				else {					status = "You must log in to excute this command ("							+ command + ").";					stat = 1;					server.config_session_id = 0;					server.config_auth = 0;				}			}// end if command != null			else {				server.config_auth = 0;				server.config_session_id = 0;			}		}// if app	}// end void	public void ParseRequest(String filename) {		p = new Properties();		int filenamelen = filename.length();		int ixQmark = filename.indexOf("?");		if (ixQmark != -1) {			String request = Jhttpp2Utils.urlDecoder(filename.substring(					ixQmark + 1, filenamelen));			if (server.debug)				System.out.println("\trequest: " + request);			p.put("requesturl", filename.substring(0, ixQmark));			if (server.debug)				System.out.println("\trequesturl: "						+ filename.substring(0, ixQmark));			GetParams(request);		} else {			p.put("requesturl", filename);			if (server.debug)				System.out.println("\trequesturl: " + filename);		}	}	public void GetParams(String request) {		boolean d = true;		int prev = 0;		while (d) {			int nextamp = request.indexOf("&", prev);			if (nextamp != -1) {				String pair = request.substring(prev, nextamp);				if (server.debug)					System.out.println("\tpair: " + pair);				ParseParam(pair, p);				prev = nextamp + 1;				pair = null;			} else {				String pair = request.substring(prev, request.length());				if (server.debug)					System.out.println("\tpair: " + pair);				ParseParam(pair, p);				pair = null;				d = false;			}		}	}	public boolean ParseParam(String pair, Properties p) {		boolean result = false;		int ixequal = pair.indexOf("=");		if (ixequal != -1) {			String param = pair.substring(0, ixequal).toLowerCase();			if (server.debug)				System.out.println("\tparam: " + param);			String val = pair.substring(ixequal + 1, pair.length());			if (server.debug)				System.out.println("\tval: " + val);			p.put(param, val);			result = true;		} else			p.put(pair, "");		return result;	}	/** html form */	public String HTMLAdmin() {		String msg = "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\"><html>\r"				+ "<!-- jHTTP admin page --><HEAD>\r"				+ "<TITLE>HTTP Admin</TITLE>\r"				+ "<link rel=\"stylesheet\" type=\"text/css\" href=\"/style.css\"></HEAD>\r"				+ "<body><h2 class=\"headline\">HTTP Configuration</h2>\r";		if (server.config_auth == 0) {			msg = msg					+ "\r"					+ "<form method=\"POST\" action=\"/"					+ server.WEB_CONFIG_FILE					+ "\">"					+ "<input type=\"hidden\" name=\"command\" value=\"auth\" />"					+ "<p>Please enter your password to access the administration form.</p>"					+ "<table border=\"0\" cellpadding=\"3\" cellspacing=\"0\">"					+ "<tr>"					+ "<td align=\"right\">Username:</td>"					+ "<td><input type=\"text\" class=\"Feld\" name=\"user\" size=\"14\" maxlength=\"40\"></td>"					+ "</tr>"					+ "<tr>"					+ "<td align=\"right\">Password:</td>"					+ "<td><input type=\"password\" class=\"Feld\" name=\"p\" size=\"17\" maxlength=\"40\"></td>"					+ "</tr>"					+ "<tr>"					+ "<td align=\"right\">"					+ "<input type=\"submit\" class=\"Button\" value=\"Submit\" name=\"B1\">"					+ "<input type=\"reset\" class=\"Button\" value=\"Reset\" name=\"B2\">"					+ "</td></tr>" + "</table>" + "</form>";		} else {			msg = msg					// Password update					+ "<form method=\"POST\" action=\"/"					+ server.WEB_CONFIG_FILE					+ "\">\r"					+ "<input type=\"hidden\" name=\"command\" value=\"update_password\"/>"					+ "<input type=\"hidden\" name=\"sid\" value=\""					+ server.config_session_id					+ "\"/>"					+ "<b>Administration Password</b>"					+ "<table align=\"center\" border=\"0\" cellspacing=\"1\" style=\"border-collapse: collapse\" bordercolor=\"#111111\" width=\"500\" height=\"32\" id=\"AutoNumber1\">"					+ txt_field("Old Password:", "", "old_pass", "", true)					+ txt_field("New Password:", "", "new_pass", "", true)					+ txt_field("Repeat New Password:", "", "new_pass2", "",							true)					+ "<tr>"					+ "<td width=\"52\" height=\"6\"></td>"					+ "<td width=\"449\" height=\"6\"><input type=\"submit\" value=\"Update Password\" /></td>"					+ "</tr>" + "</table>" + "</form>"					+ HTMLFiltersList()					+ "<a href=\"/" + server.WEB_CONFIG_FILE					+ "?command=logout&sid=" + server.config_session_id					+ "\">Logout</a></ br>;<a href=\"/" + server.WEB_CONFIG_FILE					+ "?command=shutdown&sid=" + server.config_session_id					+ "\">Shutdown Server</a>";		}		msg = msg;		if (stat >= 1) {			stat = 0;			status = "";		}		return msg.toString();	}	public static String txt_field(String a1, String o, String o2, String w,			boolean b) {		return "<tr>\r" + "<td width=\"52\" height=\"6\">" + a1 + "</td>\r"				+ "<td width=\"449\" height=\"6\">" + o				+ " <input type=\"password\" name=\"" + o2				+ "\" size=\"20\" value=\"" + w + "\"></td>\r" + "</tr>\r";	}	public static String HTMLFiltersList() {		StringBuffer out = new StringBuffer();		Enumeration an = server.getWildcardDictionary().elements();		int i = 0;		out.append("<form method=\"POST\" action=\"/"				+ server.WEB_CONFIG_FILE				+ "\">\r"				+ "<input type=\"hidden\" name=\"command\" value=\"savefilter\"/>"				+ "<input type=\"hidden\" name=\"sid\" value=\""				+ server.config_session_id				+ "\"/>"				+ "<b>URL Filter Settings</b><br>"				+ "New/Update Filter: <input type=\"text\" name=\"filter\" size=\"20\" value=\"\"></ br>"				+ "Action: <input type=\"text\" name=\"action\" size=\"10\" value=\"1\"> "				+ "<input type=\"submit\" value=\"Save\" />" + "<br>"				+ "<p style=\"font-size: 10px;\">");		while (an.hasMoreElements()) {			Jhttpp2URLMatch a = (Jhttpp2URLMatch) an.nextElement();			String aname = a.getMatch();			out.append(a.getMatch() + " ["					+ Integer.toString(a.getActionIndex()) + "] <a href=\"/"					+ server.WEB_CONFIG_FILE					+ "?command=deletefilter&filterid=" + aname + "&sid="					+ server.config_session_id + "\">Delete Filter</a>"					+ "<br>");		}		out.append("</p></form>");		return out.toString();	}}